{% extends 'core/base.html' %}
{% load static %}


{% block style %}
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
  <link href="https://raw.githack.com/ttskch/select2-bootstrap4-theme/master/dist/select2-bootstrap4.css" rel="stylesheet"> <!-- for live demo page --> 
  <!-- Style in base -->
{% endblock %}

{% block content %}

<main id="main" class="main">

    
  <div class="message-div">
    {% for message in messages %}
      <div class="container-fluid mt-1 mx-1">
        <div
          class="alert {{ message.tags }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
      </div>
    {% endfor %}
  </div>

    <div class="pagetitle">
      <h1>Create team </h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'home-page' %}">Dashboard</a></li>
          <li class="breadcrumb-item active">Create team</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <div class="row">
      <form class="row g-3 needs-validation" method="POST" action="{% url 'create-team' %}"  id="create_team_form" >
      {% csrf_token %}
      <div class="col-lg-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Choose your players <span>(Select 15) </span> </h5>
            <span id="team_details_span"></span>
            <div class="col-md-12">
              <div class="form-floating mt-3">
                <select id="selected_players" multiple data-allow-clear="1" placeholder="  Choose Players" onchange="selectedPlayers()" class="form-select" name="players" aria-label="State" required>
                  {% for key,value in team_wise_players.items %}  
                    {% for player in value %}
                      {% if player.id in selected_players %}
                        <option class="selected_players_class" selected value={{ player.id }}>{{ player.name|title }} - {{ player.team_name|title }}</option>
                      {% else %}
                        <option class="selected_players_class" value={{ player.id }}>{{ player.name|title }} - {{ player.team_name|title }}</option>
                      {% endif %}
                      {% endfor %}
                  {% endfor %}
            
                </select>
                <div id="player_errors" class="error_messages" display="none"></div>
                  {% comment %} <label for="floatingSelect">Choose Players</label>  {% endcomment %}
              </div>
            </div>   
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card">
          <div class="card-body">     
            <h5 class="card-title">Your captain <span>(x2 Pts) </span> </h5>                
            <div class="col-md-12">
              <div class="form-floating mt-3">
                <select id="select_captain"  data-allow-clear="1" placeholder=" Choose Captain"  class="form-select" name="captain" aria-label="State" onchange="selectedCaptain()" required> 
                </select>
              </div>
            </div>   
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card">
          <div class="card-body">   
            <h5 class="card-title">Your vice captain <span>(x1.5 Pts) </span> </h5> 
            <div class="col-md-12">
              <div class="form-floating mt-3">
                <select id="select_vice_captain"  data-allow-clear="1" placeholder=" Choose Vice Captain"  class="form-select" name="vice_captain" aria-label="State" onchange="selectedViceCaptain()" required>
                </select>   
              </div>
            </div>   
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Your Bonus Matches <span>(Select 3)  </span> </h5> 
            <div class="col-md-12">
              <div class="form-floating mt-3">
                <select id="selected_matches" multiple data-allow-clear="1" placeholder="  Choose Matches" class="form-select" name="matches" aria-label="State" required>
                  {% for match in all_matches %}
                    {% if match.id in selected_matches %}
                      <option class="selected_players_class" selected value={{ match.id }}>{{ match.name|title }}</option>
                    {% else %}
                      <option class="selected_players_class" value={{ match.id }}>{{ match.name|title }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
                <div id="match_errors" class="error_messages" display="none"></div>
              </div>
            </div>   
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Predict Orange Cap winner <span>(100 Pts) </span> </h5> 
            <div class="col-md-12">
              <div class="form-floating mt-3">
                <select id="selected_orange_cap" data-allow-clear="1" placeholder="  Predict Orange Cap Winner" class="form-select" name="orange_cap" aria-label="State" required>
                  <option disabled selected value> -- select an option -- </option>
                  {% for key,value in team_wise_players.items %}  
                    {% for player in value %}
                      {% if player.id == selected_orange_cap %}
                        <option class="selected_players_class" selected value={{ player.id }}>{{ player.name|title }}</option>
                      {% else %}
                        <option class="selected_players_class"  value={{ player.id }}>{{ player.name|title }}</option>
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>   
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Predict Purple Cap winner <span>(100 Pts) </span> </h5> 

            <div class="col-md-12">
              <div class="form-floating mt-3">
                <select id="selected_purple_cap" data-allow-clear="1" placeholder="  Predict Purple Cap Winner" class="form-select" name="purple_cap" aria-label="State" required>
                  <option disabled selected value> -- select an option -- </option>
                  {% for key,value in team_wise_players.items %}  
                    {% for player in value %}
                      {% if player.id == selected_purple_cap %}
                        <option class="selected_players_class" selected value={{ player.id }}>{{ player.name|title }}</option>
                      {% else %}
                        <option class="selected_players_class" value={{ player.id }}>{{ player.name|title }}</option>
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>   
          </div>
        </div>
      </div>

      <button class="btn btn-primary w-100" type="submit">
        Create Team
      </button>
      </form>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

  <!-- SELECT2 -->
  <script>

    const MAX_PLAYERS = 15;
    const MAX_MATCHES = 3;
    const MAX_PLAYERS_PER_TEAM = 3;
    var MAX_PLAYERS_PER_TEAM_ERROR = false;

    function selectedCaptain() {
      var selected_option = document.getElementById("select_captain");
      var selected_captain = selected_option.value;
      selected_players = [];
      for (var option of document.getElementById('selected_players').options)
      {
          if (option.selected && option.value != selected_captain) {
            selected_players.push([option.value, option.text]);
          }
      }

      var selected_vice_option = document.getElementById("select_vice_captain");
      var selected_vice_captain = selected_vice_option.value;

      var cap_options = ""
      for(var i=0; i<selected_players.length; i++){
        cap_options += "<option value="+ selected_players[i][0] +">"+selected_players[i][1]+"</option>"
      }
      document.getElementById("select_vice_captain").innerHTML = cap_options; 
      document.getElementById("select_vice_captain").value = selected_vice_captain; 

    }

    function selectedViceCaptain() {
      var selected_option = document.getElementById("select_vice_captain");
      var selected_vice_captain = selected_option.value;
      selected_players = [];
      for (var option of document.getElementById('selected_players').options)
      {
          if (option.selected && option.value != selected_vice_captain) {
            selected_players.push([option.value, option.text]);
          }
      }

      var selected_captain_option = document.getElementById("select_captain");
      var selected_captain = selected_captain_option.value;

      var cap_options = ""
      for(var i=0; i<selected_players.length; i++){
        cap_options += "<option value="+ selected_players[i][0] +">"+selected_players[i][1]+"</option>"
      }
      document.getElementById("select_captain").innerHTML = cap_options; 
      document.getElementById("select_captain").value = selected_captain; 
    
    }
    

    function selectedPlayers() {
      selected_players = [];
      team_wise = {};
      for (var option of document.getElementById('selected_players').options)
      {
          if (option.selected) {
            selected_players.push([option.value, option.text]);
            var team_name = option.text.split(" - ")[1]
            if(team_name in team_wise){
              team_wise[team_name] = team_wise[team_name] + 1;
            } else {
              team_wise[team_name] = 1;
            }
          }
      }
      var team_details_span = "<p>";
      var player_exceeded = false;
      for (const [key, value] of Object.entries(team_wise)){
        team_details_span += `${key} - ${value}<br/>`;
        if(value>MAX_PLAYERS_PER_TEAM){
          
          error_html = `Selected ${value} players from ${key}. Select only ${MAX_PLAYERS_PER_TEAM}`;
          document.getElementById("player_errors").style.display = "block";
          document.getElementById("player_errors").innerHTML = error_html
          player_exceeded = true;
          MAX_PLAYERS_PER_TEAM_ERROR = true;
        } 
      }
      if(!player_exceeded){
        document.getElementById("player_errors").innerHTML = ""
        document.getElementById("player_errors").style.display = "none";
        MAX_PLAYERS_PER_TEAM_ERROR = false;
      }
      team_details_span += ` Total players selected - ${selected_players.length}<br/>${MAX_PLAYERS - selected_players.length} more to go </p>`;
      document.getElementById("team_details_span").innerHTML = team_details_span;

      var cap_options = "<option disabled selected value> -- select an option -- </option>"
      for(var i=0; i<selected_players.length; i++){
        cap_options += "<option value="+ selected_players[i][0] +">"+selected_players[i][1]+"</option>"
      }
      document.getElementById("select_captain").innerHTML = cap_options;
      document.getElementById("select_vice_captain").innerHTML = cap_options;
    }

    $(function () {
      selectedPlayers()
      
      document.getElementById("select_captain").value = {{selected_captain}}
      document.getElementById("select_vice_captain").value = {{selected_vice_captain}}
      
      
      
      $.noConflict();
      $('select').each(function () {
        $(this).select2({
          theme: 'bootstrap4',
          width: 'style',
          placeholder: $(this).attr('placeholder'),
          allowClear: Boolean($(this).data('allow-clear')),
        });
      }); 
        $('#selected_matches').each(function () {
          $(this).select2({
            maximumSelectionLength: MAX_MATCHES,
            theme: 'bootstrap4',
            width: 'style',
            placeholder: $(this).attr('placeholder'),
            allowClear: Boolean($(this).data('allow-clear')),
          });
        }); 
        $('#selected_players').each(function () {
          $(this).select2({
            maximumSelectionLength: MAX_PLAYERS,
            theme: 'bootstrap4',
            width: 'style',
            placeholder: $(this).attr('placeholder'),
            allowClear: Boolean($(this).data('allow-clear')),
          });
        }); 
      });

      let createTeamForm = document.getElementById("create_team_form");
      createTeamForm.addEventListener("submit", (e) => {
        e.preventDefault();
        
        var all_players = document.getElementById('selected_players')
        var players = [...all_players.options].filter(option => option.selected)

        var all_matches = document.getElementById('selected_matches')
        var matches = [...all_matches.options].filter(option => option.selected)

        if(players.length != MAX_PLAYERS){
          document.getElementById("player_errors").style.display = "block";
          document.getElementById("player_errors").innerHTML =`You have selected ${players.length}. Please select ${MAX_PLAYERS}.`
        }
        else if(!MAX_PLAYERS_PER_TEAM_ERROR){
          document.getElementById("player_errors").style.display = "none";
        } 

        if(matches.length != MAX_MATCHES){
          document.getElementById("match_errors").style.display = "block";
          document.getElementById("match_errors").innerHTML =`You have selected ${matches.length}. Please select ${MAX_MATCHES}.`
        } else if(!MAX_PLAYERS_PER_TEAM_ERROR) {
          document.getElementById("match_errors").style.display = "none";
        }

        if(players.length == MAX_PLAYERS && matches.length == MAX_MATCHES && !MAX_PLAYERS_PER_TEAM_ERROR){
          createTeamForm.submit();
        }
      });
    </script>

{% endblock %}